<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Games Rating by Country 2015-2019</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
        }
        #tooltip {
            position: absolute;
            padding: 10px;
            background: indianred;
            color: black;
            border-radius: 3px;
            pointer-events: none;
            opacity: 0;
        }
        .country {
            stroke: black;
            stroke-width: .5px;
        }
        #credit {
            font-size: 12px;
            text-anchor: middle;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <h1>Games Rating by Country 2015-2019</h1>
    <select id="gameDropdown"></select>
    <svg id="choropleth" width="1400" height="700">
        <g id="countries"></g>
        <g id="legend"></g>
    </svg>
    <div id="tooltip"></div>

    <script>
        var margin = {top: 50, right: 250, bottom: 50, left: 50},
            width = d3.select("#choropleth").attr("width") - margin.left - margin.right,
            height = d3.select("#choropleth").attr("height") - margin.top - margin.bottom;

        var svg = d3.select("#choropleth")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var myColors = ["#feedde", "#fdbe85", "#fd8d3c", "#e6550d"];
        var colorScale = d3.scaleQuantile()
            .range(myColors);

        var tooltip = d3.select("#tooltip");

        var projection = d3.geoNaturalEarth()
           .scale(width / 2)
           .translate([width / 2.8, height / 2])
            .scale(180);

        var path = d3.geoPath().projection(projection);

        var world = d3.json("world_countries.json");
        var gameData = d3.csv("ratings-by-country.csv");

        Promise.all([world, gameData]).then(ready);

        function ready([world, gameData]) {
            var games = d3.nest()
                  .key(d => d.Game)
                  .entries(gameData);

            var gameList = games.map(d => d.key);
            gameList.sort();
            var defaultStart = gameList[0]

            d3.select("#gameDropdown")
              .selectAll("option")
              .data(gameList)
              .enter()
              .append("option")
              .text(d => d)
              .attr("value", d => d);

            createMapAndLegend(world, gameData, defaultStart);

            d3.select("#gameDropdown").on("change", function() {
                createMapAndLegend(world, gameData, this.value);
            });
        }

        function createMapAndLegend(world, gameData, selectedGame) {
            d3.select("#countries").selectAll("*").remove();
            d3.select("#legend").selectAll("*").remove();

            var filteredData = gameData.filter(d => d.Game === selectedGame);

            var ratings = filteredData.map(d => +d["Average Rating"]);
            colorScale.domain(ratings);

            d3.select("#countries")
                .selectAll("path")
                .data(world.features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("d", path)
                .on("mouseover", function(d) {
                    var countryData = filteredData.find(rating => rating.Country === d.properties.name);
                    var html = "Country: " + d.properties.name + "<br/>" +
                               "Game: " + selectedGame + "<br/>";

                    if (countryData) {
                        html += "Average Rating: " + countryData["Average Rating"] + "<br/>" +
                                "Number of Users: " + countryData["Number of Users"];
                    } else {
                        html += "Average Rating: N/A<br/>" +
                                "Number of Users: N/A";
                    }

                    tooltip.html(html)
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                        .style("opacity", 1);
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                })
                .style("fill", d => {
                    var countryData = filteredData.find(rating => rating.Country === d.properties.name);
                    return countryData ? colorScale(+countryData["Average Rating"]) : "#ccc";
                });

            var legend = d3.legendColor()
               .labelFormat(d3.format(".2f"))
               .title("Average Rating")
               .scale(colorScale);

            d3.select("#legend")
                .attr("transform", "translate(800,20)")
                .call(legend);

            svg.append("text")
                .attr("id", "credit")
                .attr("transform", "translate(500,550)")
                .text("hpavlovich3");
        }
    </script>
</body>
</html>