<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Games Rating: 2015 - 2019</title>

    <script src = "../lib/d3.v5.min.js"></script>
    <script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/d3-dsv.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>
    <script src="../lib/topojson.v2.min.js"></script>
    <script src="../lib/d3-legend.min.js"></script>


    <style>
        body {
            font-family: sans-serif;
        }
    .divtip{
        position: absolute;
        text-align: center;
        width: 175px;
        height: 70px;
        padding: 5px;
        font-size: 12px;
        background-color: indianred;
        border-color: black;
        border: 1px ;
        border-radius: 5px;
        pointer-events: none;
        opacity: 30;
    }

    .dropdown{
        position: absolute;
        top: 20px;
        left:20px
    }

    </style>


</head>
<body>

    <h1>Games Rating by Country 2015-2019</h1>

    <!-- Create dropdown element here. Options should be added after reading in game file, they should not be created here.-->
    <select id ="gameDropdown"></select>
    <svg id ="choropleth" width = "1400" height = "700">
        <g id = "countries">
            <path></path>
            </g>
        <g id= "legend"></g>
    </svg>
    <div id= "tooltip" display = "block" pointer-events = "none"></div>

    <script>

        // enter code to define margin and dimensions for svg
        var margin = {top: 80, right: 120, bottom: 40, left: 100}
        var width = 1400 - margin.left - margin.right

        var height = 700 - margin.top - margin.bottom

        // enter code to create svg
        var svg = d3.select("#choropleth")
            .attr("width", width)
            .attr("height", height)

        var countries = svg.select("#countries")
            .attr("transform", "translate(" + margin.left*-1 + ", "+ margin.bottom+")")

        // enter code to create color scale
        var myColors = ["#feedde","#fdbe85","#fd8d3c","#e6550d"]
        var quantileColor = d3.scaleQuantile().range(myColors)

        				// enter code to define tooltip
        var tooltip = d3.tip()
            .attr('class','divtip')
            .attr('id', 'tooltip')
            .style("opacity", 0)
            .offset([10,10])
            .html(d=> {
                if (d.info === undefined) {
                    return (
                        "Country: " + d.properties.name
                        + "<br/> Game: " + d.game
                        + "<br/> Avg Rating: " + "N/A"
                        + "<br/> Number of users: " + "N/A"
                    )
                } else {
                    return (
                        "Country: " + d.info["Country"]
                        + "<br/> Game: " + d.info["Game"]
                        + "<br/> Avg Rating: " + d.info["Average Rating"]
                        + "<br/> Number of users: " + d.info["Number of Users"]
                    )
                }
            })


        // enter code to define projection and path required for Choropleth
        // For grading, set the name of functions for projection and path as "projection" and "path"

        var projection = d3.geoNaturalEarth()
            .translate([width/2.5, height/2])
            .scale(150)

        var path = d3.geoPath().projection(projection)

        // define any other global variables
   //     var world, gameData
   //     var games = new Set()

        Promise.all([d3.json("world_countries.json"), d3.csv("ratings-by-country.csv")
        ]).then(data=> {
            world = data[0]
            gameData = data[1]

            ready(null, world, gameData)
        })

        function ready(error, world, gameData) {
            if (error) throw error

            var games = gameData.map(d=> d.Game) // map games
            var gamesList = Array.from(new Set(games)).sort(d3.ascending) // only unique
            console.log("gamesList "+gamesList)

            var defaultGame = gamesList[0]
            var game1 = defaultGame

            var dropOption = d3.select("#gameDropdown")
                .selectAll("options")
                .data(gamesList)
                //.attr("id", "dropdown")
                .enter()
                .append("option")
                .text(d=>d)
                .attr("value", d=>d)

            var switchOption = function(){
                game1 = d3.select(this).property('value')
                createMapAndLegend(world, gameData, game1)
            }

            createMapAndLegend(world, gameData, defaultGame)
            dropOption.on("change", switchOption);
        }

        // this function should create a Choropleth and legend using the world and gameData arguments for a selectedGame
        // also use this function to update Choropleth and legend when a different game is selected from the dropdown
        function createMapAndLegend(world, gameData, selectedGame){
            console.log("createMapandLegend on the run")
           // svg.call(tooltip)
            Promise.all([world, gameData])
                .then(data => {
                    console.log("data "+data)
                    svg.call(tooltip)
                    countryMap = d3.select("#countries")
                        .selectAll("path")
                        .data(world.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .attr("stroke","black")
                        .on("mouseover", d => {
                            tooltip.show(d)
                        })
                        .on("mouseout", tooltip.hide)
                        .style("fill", d => {
                            console.log(d)
                            world.features.forEach(d => {
                                d["Game"] = selectedGame
                            })

                            var filteredData = gameData.filter(d => d["Game"] === selectedGame);

                            // Find the min and max ratings from the filtered data
                            var min = d3.min(filteredData, d => +d["Average Rating"]);
                            var max = d3.max(filteredData, d => +d["Average Rating"]);

                            var color = "lightgray"
                            // Iterate over ratings to find the corresponding info and color
                            gameData.forEach(r => {
                                console.log(d)
                                if ((r["Game"] === selectedGame )&& (d.properties.name === r["Country"])) {
                                    d["info"] = {
                                        "Country": d.properties.name,
                                        "Game": selectedGame,
                                        "Average Rating": r["Average Rating"],
                                        "Number of Users": r["Number of Users"]
                                    };
                                    quantileColor.domain([min, max]); // Set the domain for the color scale
                                    color = quantileColor(+r["Average Rating"]); // Get the color for the rating
                                }
                            });
                            return color
                        })

                    var legendHold = d3.select("#legend")
                        .attr("class", "legendQuant")
                        .attr("transform", "translate(0,0)")

                    var legend = d3.legendColor()
                        .labelFormat(d3.format(".2f"))
                        .title("Average Rating")
                        .titleWidth(20)
                        .scale(quantileColor)

                    legendHold.select(".legendQuant")
                        .call(legend)
                })
            svg.append("text")
                .attr("transform", "translate(500,height-margin.bottom)")
                .text("hpavlovich3")

        }//.catch(function (error) {
      //console.log(error);
    </script>

</body>

</html>