<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Games Rating: 2015 - 2019</title>
    <meta charset="utf-8">
    
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>
    <script src="../lib/d3-legend.min.js"></script>
    <script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/topojson.v2.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
        }
        #tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            visibility: hidden;
        }
    
    </style>

    <title></title>

</head>
<body>


    <h1>Games Rating by Country 2015-2019</h1>
    
    <!-- Create dropdown element here. Options should be added after reading in game file, they should not be created here.-->
    <select id ="gameDropdown">
        <option>Select a game</option>
    </select>
    <svg id ="choropleth" width = "1400" height = "700">
        <g id = "countries">
            <path id = "lines"></path>
            </g>
        <g id= "legend"></g>
    </svg>
    <div id= "tooltip"></div>



    <script>
    
        // enter code to define margin and dimensions for svg
        var margin = {top: 80, right: 120, bottom: 40, left: 100}
        var width = d3.select("#choropleth")
            .attr("width") - margin.left - margin.right

        var height = d3.select("#choropleth")
            .attr("height") - margin.top - margin.bottom

        // enter code to create svg
        var svg = d3.select("#choropleth")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .style("background-color","#c9e8fd")
            .attr("viewBox", "0 0 " + width + " " + height)
            .classed("svg-content", true)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // enter code to create color scale
        //var colorScale =
        // enter code to define tooltip
        var tooltip = d3.select("#tooltip")
        // enter code to define projection and path required for Choropleth
        // For grading, set the name of functions for projection and path as "projection" and "path"

        var projection = d3.geoMercator()
            .translate([width/2, height/2])
            .scale(2200)
            .center([0,40]);
        var path = d3.geoPath()
            .projection(projection);

        // define any other global variables
        var countries = svg.select("#countries")

        Promise.all([d3.json("world_countries.json"), d3.csv("ratings-by-country.csv")
        ]).then(([world, ratings]) => {
            ready(world, ratings)
            })

        function ready(world, gameData) { //ready(error, world, gameData)
            var games = Array.from(new Set(gameData.map(d => d.Game))).sort() // WHAT DOES THIS MEAN
            var drop_option = d3.select("#gameDropdown")

            drop_option.selectAll("option")
                .data(games)
                .enter()
                .append("option")
                .text(d=>d)

            var game1 = games[0]
            drop_option.property("value", game1)
            createMapAndLegend(world, gameData, game1)

            drop_option.on("change", function() {
                var selectedGame = d3.select(this).property("value")
                createMapAndLegend(world, gameData, selectedGame)
        })

        }

        // this function should create a Choropleth and legend using the world and gameData arguments for a selectedGame
        // also use this function to update Choropleth and legend when a different game is selected from the dropdown
        function createMapAndLegend(world, gameData, selectedGame){
            var ratingsCountry = d3.nest()
                .key(d => d.country)
                .rollup(v => ({
                    avgRating: d3.mean(v, d => +d['Average Rating']),
                    numUsers: d3.sum(v, d => +d['Number of Users'])
                })).entries(gameData)

            var countryMap = {}
            ratingsCountry.forEach(d=>{
                countryMap[d.key] = d.value
            })

            var myColors = d3.scaleQuantize()
                .domain([0, d3.max(ratingsCountry, d => d.value.avgRating || 0)])
                .range(d3.schemeBlues[4]);

            countryPath = countries.select("#lines")
                .data(world.features)

            countryPath.append("path")
                .attr("class", "country")
                .attr("d", path)
                .attr("fill", "gray")

                .attr("d", path)
                .attr("fill", d=> {
                    var rating  = countryMap[d.properties.name]
                    return rating ? myColors(rating.avgRating) : "gray"
                })
                .on("mousover", function(event, d){
                    var ratingInfo = countryMap[d.properties.name]
                    tooltip.style("visibility", "visible")
                        .html(`
                               <strong>${d.properties.name}</strong><br>
                               Game: ${selectedGame}<br>
                               Avg Rating: ${ratingInfo ? ratingInfo.avgRating.toFixed(2) : "N/A"}<br>
                               Users: ${ratingInfo ? ratingInfo.numUsers : "N/A"}
                           `)
                    var [x,y] = d3.pointer(event)
                    tooltip.style("top", (y+5) + "px").style("left", (x+5) + "px")
                })
                .on("mouseout", ()=> tooltip.style("visibility", "hidden"))

            var legend = svg.select("#legend")
                .data(myColors.range())
                .enter()
                .append("g")
                .attr("class", "legend")
                .attr("transform", (d,i) => `translate(0,${i * 20})`)

            legend.append("rect")
                .attr("x", width -20)
                .attr("width", 20)
                .attr("height", 20)
                .style("fill", d=>d)

            legend.append("text")
                .attr("x", width-30)
                .attr("y", 10)
                .attr("dy", ".35em")
                .text((d,i)=> {
                        var values = myColors.domain()
                        return `${values[i] ? values[i].toFixed(2) : "N/A"} - ${values[i + 1] ? values[i + 1].toFixed(2) : "N/A"}`
                    })

            
        }//.catch(function (error) {
      //console.log(error);
    </script>

</body>

</html>