<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Games Rating: 2015 - 2019</title>
    <meta charset="utf-8">
    
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>
    <script src="../lib/d3-legend.min.js"></script>
    <script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/topojson.v2.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
        }
        #tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: lightsteelblue;
            border: 2px;
            border-radius: 8px;
            pointer-events: none;
        }
    
    </style>

    <title></title>

</head>
<body>


    <h1>Games Rating by Country 2015-2019</h1>
    
    <!-- Create dropdown element here. Options should be added after reading in game file, they should not be created here.-->
    <select id ="gameDropdown">
        <option></option>
    </select>
    <svg id ="choropleth" width = "1400" height = "700">
        <g id = "countries">
            <path id = "lines"></path>
            </g>
        <g id= "legend"></g>
    </svg>
    <div id= "tooltip"></div>



    <script>
    
        // enter code to define margin and dimensions for svg
        var margin = {top: 80, right: 120, bottom: 40, left: 100}
        var width = d3.select("#choropleth")
            .attr("width") - margin.left - margin.right

        var height = d3.select("#choropleth")
            .attr("height") - margin.top - margin.bottom

        // enter code to create svg
        var svg = d3.select("#choropleth")
            .attr("width", width)
            .attr("height", height)

        var countries = svg.select("#countries")
            .attr("transform", "translate(" + margin.left + ", "+ 1.5*margin.bottom+")")
        // enter code to create color scale
        var myColors = ["#feedde","#fdbe85","#fd8d3c","#d94701"]
        var colorScale = d3.scaleThreshold()
            .range(myColors)

        // enter code to define tooltip
        var tooltip = d3.select("#tooltip") //div
            .enter()
            .attr('class', 'tip')

        // enter code to define projection and path required for Choropleth
        // For grading, set the name of functions for projection and path as "projection" and "path"

        var projection = d3.geoEqualEarth()
            .translate([width/2, height/2])
            .scale(150)

        var path = d3.geoPath(projection)

        // define any other global variables
        var world, gameData
        var games = new Set()

        Promise.all([d3.json("world_countries.json"), d3.csv("ratings-by-country.csv")
        ]).then(data => {
            world = data[0]
            gameData = data[1]

            ready(null, world, gameData)
            })

        function ready(error, world, gameData) { //ready(error, world, gameData)
            if (error) throw error

            var games = gameData.map(d=> d.Game) // map games
            var gameSet = new Set(games) // only unique
            let gamesList = Array.from(gameSet)
            var game1 = gamesList[0]

            var nextGame = game1

            var dropOption = d3.select("#gameDropdown")
            dropOption.selectAll("option1")
                .data(gamesList.sort(d3.ascending))
                .enter()
                .append("option")
                .text(d=>d)
                .attr("value", d=>d)

            tooltip.html(function(d) {
                var avgRating = "N/A"
                var numUsers = "N/A"
                var dataPresent = false
                gameData.forEach(v => {
                    if (v.Country == d.properties.name && v.Game == game1) {
                        numUsers = +v['Number of Users']
                        avgRating = +v['Average Rating']
                        dataPresent = true
                    }
                })
                return "Country: " + d.properties.name
                    + "<br/> Game:" + game1
                    + "<br/> Avg Rating: " + avgRating
                    + "</br> Number of users: " + numUsers
                })

            var switchOption = function(){
                game1 = d3.select(this).property('value')
                createMapAndLegend(world, gameData, game1)
            }

            createMapAndLegend(world, gameData, game1)
            dropOption.on("change", switchOption)

        }

        // this function should create a Choropleth and legend using the world and gameData arguments for a selectedGame
        // also use this function to update Choropleth and legend when a different game is selected from the dropdown
        function createMapAndLegend(world, gameData, selectedGame){
            var nestedData = d3.nest()
                .key(d => d.Game)
                .key(d => d.Country)
                .rollup(v => d3.mean(v, d => +d['Average Rating']))
                .entries(gameData);

            // Filter for the selected game and extract the country names and average ratings
            var selectedGameData = nestedData.find(d => d.key === selectedGame);

            var countryMap = selectedGameData ? selectedGameData.values.map(d => d.key) : [];
            var hold = selectedGameData ? selectedGameData.values.map(d => d.value) : [];
            var ratingsCountry = hold;

            var quantileSort = d3.scaleQuantile()
                .domain(hold.sort(d3.ascending))
                .range(colorScale)
            var ratingSort = hold.sort(d3.ascending)

            var countryPath = countries.select("#lines")
                .selectAll("path")
                .data(world.features)


            var gameSelection = countryPath.enter()
                .append("path")
                .attr("d", path)
                .attr("stroke", "black")
                .attr("fill", "gray")

            countryPath.merge(gameSelection)
                .attr("d", path)
                //.style("fill", d => {
              //          var countryRating = ratingsCountry.find(r => r.key === d.properties.name);
            //            return countryRating ? quantileSort(countryRating.value.avgRating) : "gray";
             //  })

                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(/* tooltip content here */)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition().duration(500).style("opacity", 0);
                });
            countryPath.exit().remove()


            colorScale.domain(hold.sort(d3.ascending))
                        // Format function for rounding
            var Dec2 = d3.format(".2f");

            var first = Dec2(d3.quantile(ratingSort,0)) + " to " + Dec2(d3.quantile(ratingSort, 0.25));
            var second = Dec2(d3.quantile(ratingSort,0.25)) + " to " + Dec2(d3.quantile(ratingSort, 0.50));
            var third = Dec2(d3.quantile(ratingSort,0.50)) + " to " + Dec2(d3.quantile(ratingSort, 0.75));
            var fourth = Dec2(d3.quantile(ratingSort,0.75)) + " to " + Dec2(d3.quantile(ratingSort, 1));
            var labels = [first,second,third,fourth]

            var legend = svg.select("#legend")

            legend.attr("class", "legendQuant")
                .attr("transform", "translate(20,20)")

            var legendColor = d3.legendColor()
                .labels(function(d) {return labels[d.i]}) // Use custom labels
                 .shapeWidth(20)
                 .orient("vertical")
                 .title("Average Rating")
                 .scale(colorScale)
                 // Apply the color scale

            legend.call(legendColor)
            console.log(ratingsCountry)

            countryPath.style("fill", d=>{
                var emptyCountry = countryMap.indexOf(d.properties.name)
                if (emptyCountry == -1) {
                    return "gray"
                }
                else{
                    var rating = ratingsCountry[emptyCountry]
                    return quantileSort(rating)
                }
            })

            svg.append("text")
                .attr("transform", "translate(500,510)")
                .text("hpavlovich3");
            
        }//.catch(function (error) {
      //console.log(error);
    </script>

</body>

</html>