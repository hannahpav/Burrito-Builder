<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Games Rating: 2015 - 2019</title>
    <meta charset="utf-8">
    
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>
    <script src="../lib/d3-legend.min.js"></script>
    <script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/topojson.v2.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
        }
        #tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: lightsteelblue;
            border: 2px;
            border-radius: 8px;
            pointer-events: none;
        }
    
    </style>

    <title></title>

</head>
<body>


    <h1>Games Rating by Country 2015-2019</h1>
    
    <!-- Create dropdown element here. Options should be added after reading in game file, they should not be created here.-->
    <select id ="gameDropdown">
        <option>Select a game</option>
    </select>
    <svg id ="choropleth" width = "1400" height = "700">
        <g id = "countries">
            <path id = "lines"></path>
            </g>
        <g id= "legend"></g>
    </svg>
    <div id= "tooltip"></div>



    <script>
    
        // enter code to define margin and dimensions for svg
        var margin = {top: 80, right: 120, bottom: 40, left: 100}
        var width = d3.select("#choropleth")
            .attr("width") - margin.left - margin.right

        var height = d3.select("#choropleth")
            .attr("height") - margin.top - margin.bottom

        // enter code to create svg
        var svg = d3.select("#choropleth")
            .attr("width", width)
            .attr("height", height)

        var countries = svg.select("#countries")
            .attr("transform", "translate(" + margin.left + ", "+ 1.5*margin.bottom+")")

        // enter code to create color scale
        var myColors = ["#feedde","#fdbe85","#fd8d3c","#d94701"]
        var colorScale = d3.scaleThreshold()
            .range(myColors)
        // enter code to define tooltip
        var tooltip = d3.select("#tooltip")
            .style('opacity', 0)
            .style('position', 'absolute')

        // enter code to define projection and path required for Choropleth
        // For grading, set the name of functions for projection and path as "projection" and "path"

        var projection = d3.geoEqualEarth()
            .translate([width/2, height/2])
            .scale(150)

        var path = d3.geoPath(projection);

        // define any other global variables


        Promise.all([d3.json("world_countries.json"), d3.csv("ratings-by-country.csv")
        ]).then(data => {
            world = data[0]
            gameData = data[1]

            ready(null, world, gameData)
            })

        function ready(error, world, gameData) { //ready(error, world, gameData)
            if (error) throw error
            var games = gameData.map(d=> d.Game) // map games
            var gameSet = new Set(games) // only unique
            let gamesList = Array.from(gameSet)
            var game1 = gamesList[0]
            var dropOption = d3.select("#gameDropdown")

            dropOption.selectAll("option1")
                .data(gamesList.sort(d3.ascending))
                .enter()
                .append("option")
                .text(d=>d)
                .attr("value", d=>d)

            //var game1 = games[0]
            tooltip.html(function(d) {
                var avgRating = "N/A"
                var numUsers = "N/A"
                var dataPresent = false
                gameData.forEach(v => {
                    if (v.Country == d.properties.name && v.Game == game1) {
                        numUsers = +v['Number of Users']
                        avgRating = +v['Average Rating']
                        dataPresent = true
                    }
                })
                return "Country: " + d.properties.name
                    + "<br/> Game:" + game1
                    + "<br/> Avg Rating: " + avgRating
                    + "</br> Number of users: " + numUsers
                })

            dropOption.on("change", function() {
                var selectedGame = d3.select(this).property("value")
                createMapAndLegend(world, gameData, selectedGame)
            })



        }

        // this function should create a Choropleth and legend using the world and gameData arguments for a selectedGame
        // also use this function to update Choropleth and legend when a different game is selected from the dropdown
        function createMapAndLegend(world, gameData, selectedGame){

            var filteredData = game.Data.filter(d=> d.Game === selectedGame)

            var ratingsCountry = d3.nest()
                .key(d => d.Country)
                .rollup(v => ({
                    avgRating: d3.mean(v, d => +d['Average Rating']),
                    numUsers: d3.sum(v, d => +d['Number of Users'])
                })).entries(filteredData)

            var countryMap = ratingsCountry.map(d => d.key); // Extract country names
            var allRatings = ratingsCountry.map(d => d.value.avgRating)
            var hold = ratingsCountry.map(d => d.value.avgRating)

            countryPath = countries.select("#lines")
                .data(world.features)

            countryPath.append("path")
                .attr("d", path)
                .attr("stroke", "black")
                .attr("fill", "gray")

                .attr("d", path)
                .attr("fill", d=> {
                    var rating  = countryMap[d.properties.name]
                    return rating ? colorScale(allRatings.avgRating) : "gray"
                })

                .on("mouseover", d => {
                    tooltip.hide(d)
                    d3.select(this)
                        .style('stroke-width', 4)
                })
                .on("mouseout", d=> {
                    tooltip.hide(d)
                    d3.select(this)
                        .style('stroke-width', 1)
                })

            var quantileSort = d3.scaleQuantile()
                .domain(hold.sort(d3.ascending))
                .range(colorScale)

            colorScale.domain(temp.sort(d3.ascending))

                        // Format function for rounding
            var Dec2 = d3.format(".2f");

            var first = Dec2(d3.quantile(rating_sort,0)) + " to " + f(d3.quantile(rating_sort, 0.25));
            var second = Dec2(d3.quantile(rating_sort,0.25)) + " to " + f(d3.quantile(rating_sort, 0.50));
            var third = Dec2(d3.quantile(rating_sort,0.50)) + " to " + f(d3.quantile(rating_sort, 0.75));
            var fourth = Dec2(d3.quantile(rating_sort,0.75)) + " to " + f(d3.quantile(rating_sort, 1));
            var labels = [first,second,third,fourth]

            var legend = svg.select("#legend")
                .attr('class', 'legendQuant')
                .attr("transform", "translate(20,20)");

            var legend_hold = d3.legendColor()
                .labels(d=> {
                    return labels[d.i]
                })
                      .shapeWidth(30)
                      .orient('horizontal')
                      .scale(colorScale);
            legend.call(legend_hold)



            svg.select(".legendColor")
                .call(legend)

            countryPath.style("fill", d=>{
                var emptyCountry = countries.indexOf(d.properties.name)
                if (emptyCountry == -1) {
                    return "gray"
                }
                else{
                    var rating = allRatings[index]
                    return quantileSort(rating)
                }
            })

            svg.append("text")
                .attr("transform", "translate(500,510)")
                .text("hpavlovich3");
            
        }//.catch(function (error) {
      //console.log(error);
    </script>

</body>

</html>