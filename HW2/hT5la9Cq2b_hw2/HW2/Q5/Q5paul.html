<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <!-- add title -->
    <title>Average Rating of Board Games Across the World</title>
    
    <!-- import required libraries here -->
    <meta charset="utf-8">
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="../lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="../lib/topojson.v2.min.js"></script>
    <script type="text/javascript" src="../lib/d3-geo-projection.v2.min.js"></script>
    <link href="Q5.css" rel="stylesheet" type="text/css">
</head>
<body>
    <!-- Add heading for the visualization -->
    
    <!-- Create dropdown element here. Options should be added after reading in game file, they should not be created here.-->
    <label for="gameDropdown"></label><select id="gameDropdown"></select>
    <div id="choropleth"></div>


    <script>
    
        // enter code to define margin and dimensions for svg
        const margin = 75;
        const width = 960 - margin*2;
        const height = 500 - margin*2;

        // enter code to create svg
        const svg = d3.select("#choropleth").append("svg")
            .attr("width", width + margin*2)
            .attr("height", height + margin*2);
        const countries = svg.append("g")
            .attr("id", "countries");
        const legend = svg.append("g")
            .attr("id", "legend")

        // enter code to create color scale
        const colors = ["#a6bddb", "#3690c0","#0570b0","#023858"]
        const color = d3.scaleQuantile().range(colors);
        
        // enter code to define tooltip
        const tooltip = d3.select("#choropleth").append("div")
            .attr("id", "tooltop")
            .attr("class", "tooltip");
        
        // enter code to define projection and path required for Choropleth
        // For grading, set the name of functions for projection and path as "projection" and "path"
        const projection = d3.geoNaturalEarth()
            .translate([width/2, height])
            .scale([150]);
        const path = d3.geoPath().projection(projection);

        // define any other global variables
        Promise.all([
            // enter code to read files
            d3.dsv(",","ratings-by-country.csv"),
            d3.json("world_countries.json")
        ]).then(
            // console.log()
            // enter code to call ready() with required arguments
            function (files){
                let ratings = files[0];
                let world_map = files[1];
                for (let i = 0; i < world_map.features.length; i++){
                    world_map.features[i].properties.value_list = []
                    world_map.features[i].properties.game_list = []
                    world_map.features[i].properties.user_list = []
                }// End of for loop
                console.log(world_map)
                for (let j = 0; j < ratings.length; j++){
                    let country_rate = ratings[j].Country;
                    let value_rate = parseFloat(ratings[j]["Average Rating"]);
                    let user_rate = parseFloat(ratings[j]["Number of Users"]);
                    for (let k = 0; k < world_map.features.length; k++){
                        let a_country = world_map.features[k].properties.name;
                        if (country_rate === a_country){
                            world_map.features[k].properties.value_list.push(value_rate)
                            world_map.features[k].properties.game_list.push(ratings[j].Game)
                            world_map.features[k].properties.user_list.push(user_rate)
                            break;
                        }// End of if statement
                    }// End of inner for loop
                }// End of outer for loop
                ready(null, world_map, ratings);
                // console.log(ratings)
            }// End of Function
        );
        
        // this function should be called once the data from files have been read
        // world: topojson from world_countries.json
        // gameData: data from ratings-by-country.csv
        
        function ready(error, world, gameData) {
            // enter code to extract all unique games from gameData
            let game_names = d3.map(gameData, function (d){
                return d.Game
            }).keys()
            game_names = game_names.sort(d3.ascending);

            // enter code to append the game options to the dropdown
            d3.select("#gameDropdown")
                .selectAll("option")
                .data(game_names)
                .enter()
                .append("option")
                .text(function (d){
                    return d;
                })
                .attr("value", function (d){
                    return d;
                })
            // event listener for the dropdown. Update choropleth and legend when selection changes.
            // Call createMapAndLegend() with required arguments.
            d3.select("#gameDropdown").on("change", function (){
                let selectGame = d3.select(this).property("value")
                createMapAndLegend(world, gameData, selectGame)
            })
            // create Choropleth with default option. Call createMapAndLegend() with required arguments.
            let chosen_game_values = [];
            for (let h = 0; h < world.features.length; h++){
                let games = world.features[h].properties.game_list;
                let values = world.features[h].properties.value_list;
                if (games.includes("6 nimmt!")){
                    for (let c = 0; c < games.length; c++){
                        if (games[c] === "6 nimmt!"){
                            chosen_game_values.push(values[c]);
                            break;
                        }// End of inner if statement
                    }// End of inner for loop
                }// End of outer if statement
            }// End of for loop
            color.domain(chosen_game_values.sort(d3.ascending))
            countries.selectAll("path")
                .data(world.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", function (d){
                    if (d.properties.game_list.includes("6 nimmt!")){
                        let value = 0;
                        for (let i = 0; i < d.properties.game_list.length; i++){
                            if (d.properties.game_list[i] === "6 nimmt!"){
                                value = d.properties.value_list[i];
                                break;
                            }// End of inner if statement
                        }// End of for loop
                        return color(value);
                    }else{
                        return "grey";
                    }
                })
                .attr("stroke", "black")
                .attr("stroke-width", "0.6")
                .on("mouseover", function (d){
                    let game_name = "6 nimmt!";// initialize
                    let country_name = d.properties.name;
                    if (d.properties.game_list.includes(game_name)){
                        for (let m = 0; m < d.properties.game_list.length; m++){
                            if (d.properties.game_list[m] === game_name){
                                avg_rating = d.properties.value_list[m];
                                num_users = d.properties.user_list[m];
                                break;
                            }// End of inner if statement
                        }// End of for loop
                    }else{
                        avg_rating = "N/A";
                        num_users = "N/A";
                    }// End of if-else block
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(
                        "Country: " + country_name + "<br/>"
                        + "Game: " + game_name + "<br/>"
                        + "Avg Rating: " + avg_rating + "<br/>"
                        + "Number of Users: " + num_users
                    )
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY + 30) + "px");
                })
                .on("mouseout", function (){
                    tooltip.transition().duration(500).style("opacity", 0);
                })
            for (let j = 0; j < colors.length; j++){
                legend.append("rect")
                    .attr("x", 700)
                    .attr("y", 20 + j*20)
                    .attr("height", 15)
                    .attr("width", 15)
                    .attr("fill", colors[j]);
            }
            legend.append("text")
                .text(d3.min(chosen_game_values) + "-" + color.quantiles()[0])
                .attr("class", "quant1")
                .attr("x", 725)
                .attr("y", 30)
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .style("font-size", "12px")
                .style("stroke-width", 1)
                .style("fill", "black")
                .style("font-family", "sans-serif");
            legend.append("text")
                .text(color.quantiles()[0] + "-" + color.quantiles()[1])
                .attr("class", "quant2")
                .attr("x", 725)
                .attr("y", 50)
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .style("font-size", "12px")
                .style("stroke-width", 1)
                .style("fill", "black")
                .style("font-family", "sans-serif");
            legend.append("text")
                .text(color.quantiles()[1] + "-" + color.quantiles()[2])
                .attr("class", "quant3")
                .attr("x", 725)
                .attr("y", 70)
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .style("font-size", "12px")
                .style("stroke-width", 1)
                .style("fill", "black")
                .style("font-family", "sans-serif");
            legend.append("text")
                .text(color.quantiles()[2] + "-" + d3.max(chosen_game_values))
                .attr("class", "quant4")
                .attr("x", 725)
                .attr("y", 90)
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .style("font-size", "12px")
                .style("stroke-width", 1)
                .style("fill", "black")
                .style("font-family", "sans-serif");
        }// End of ready function

        // this function should create a Choropleth and legend using the world and gameData arguments for a selectedGame
        // also use this function to update Choropleth and legend when a different game is selected from the dropdown
        function createMapAndLegend(world, gameData, selectedGame){
            let chosen_game_values = [];
            for (let k = 0; k < world.features.length; k++){
                var games = world.features[k].properties.game_list;
                var values = world.features[k].properties.value_list;
                if (games.includes(selectedGame)){
                    for (n = 0; n < games.length; n++){
                        if (games[n] === selectedGame){
                            chosen_game_values.push(values[n]);
                            break;
                        }// End of inner if statement
                    }// End of inner for loop
                }// End of outer if statement
            }// End of outer for loop
            color.domain(chosen_game_values.sort(d3.ascending))
            countries.selectAll("path")
                .attr("fill", function (d){
                    if (d.properties.game_list.includes(selectedGame)){
                        value = 0;
                        for (let i = 0; i < d.properties.game_list.length; i++){
                            if (d.properties.game_list[i] === selectedGame){
                                value = d.properties.value_list[i];
                                break
                            }// End of inner if statement
                        }// End of for loop
                        return color(value);
                    }else{
                        return "#A4A3A2";
                    }// End of if-else block
                })
                .attr("stroke", "black")
                .attr("stroke-width", "0.5")
                .on("mouseover", function (d){
                    game_name = selectedGame;
                    country_name = d.properties.name;
                    if (d.properties.game_list.includes(game_name)){
                        for (let j = 0; j < d.properties.game_list[j]; j++){
                            if (d.properties.game_list[j] === game_name){
                                avg_rating = d.properties.value_list[j];
                                num_users = d.properties.user_list[j];
                                break;
                            }// End of inner if statement
                        }// End of for loop
                    }else{
                        avg_rating = "N/A";
                        num_users = "N/A";
                    }// End if if-else block
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(
                        "Country: " + country_name + "<br/>"
                        + "Game: " + game_name + "<br/>"
                        + "Avg Rating: " + avg_rating + "<br/>"
                        + "Number of Users: " + num_users
                    )
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY + 30) + "px");
                })
                .on("mouseout", function (){
                    tooltip.transition().duration(500).style("opacity", 0);
                })
            legend.selectAll(".quant1").text(d3.min(chosen_game_values) + "-" + color.quantiles()[0]);
            legend.selectAll(".quant2").text(color.quantiles()[0] + "-" + color.quantiles()[1]);
            legend.selectAll(".quant3").text(color.quantiles()[1] + "-" + color.quantiles()[2]);
            legend.selectAll(".quant4").text(color.quantiles()[2] + "-" + d3.max(chosen_game_values));
        }
    </script>
</body>