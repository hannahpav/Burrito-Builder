<!DOCTYPE html>

<head>
  <title>Games Rating: 2015 - 2019</title>
  <meta charset="utf-8">
  <style>
    #line {
          fill: none; /* No fill for the line */
          stroke-width: 1.5;
        }

    #line_chart_title, #bar_chart_title {
      font-size: 18px;
      text-anchor: middle;
      font-family: sans-serif;
      font-weight: bold;
    }

    #x_axis_label,#y_axis_label, #bar_x_axis_label, #bar_y_axis_label {
      font-size: 14px;
      text-anchor: middle;
      font-family: sans-serif;
      font-weight: bold;
    }

    #line_label {
      font-size: 10px;
      text-anchor: left;
      font-family: sans-serif;
      font-weight: normal;
    }

    #credit {
      font-size: 12px;
      text-anchor: end;
      font-family: sans-serif

    }

  </style>
</head>

<body>
  <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
  <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>

  <!-- Example hiding an element -->
  <!-- <g id="" style"display:none;" /> -->

  <!-- Example of styling an element -->
  <!-- svg_element.style()-->

  <svg id ="line_chart" width = "800" height = "400">
    <g id = "container">
      <g id = "lines"></g>
      <g id= "x-axis-lines"></g>
      <g id= "y-axis-lines"></g>
      <g id= "circles"></g>
      <text id="line_chart_title"></text>
      <text id="credit"></text>
      <g id="legend"></g>
      </g>
  </svg>
  <div id="bar_chart_title" style="text-align: center; margin-top: 40px;"></div>
  <svg id ="bar_chart" width = "800" height = "400">
    <g id="container_2">
      <g id="bars"></g>
      <g id="x-axis-bars"></g>
      <g id="y-axis-bars"></g>
      <text id ="bar_x_axis_label"></text>
      <text id="bar_y_axis_label"></text>
      </g>
  </svg>

  <script>

  // get data

  // Fetch the data
	var pathToCsv = "average-rating.csv";

    d3.dsv(",", pathToCsv).then(data_raw => {
      data_raw.forEach(d => {
        d.name = d.name
        d.year = +d.year
        d.average_rating = Math.floor(+d.average_rating)
        d.users_rated = +d.users_rated
      })

        //     var startYear = d3.timeParse("%Y")(2015);
        //     var endYear = d3.timeParse("%Y")(2019);

        var data = data_raw.filter(row => {
          return 2015 <= row.year && row.year <= 2019;
        });

        var margin = {top: 80, right: 120, bottom: 40, left: 100}
        var width = d3.select("#line_chart")
                .attr("width") - margin.left - margin.right

        var height = d3.select("#line_chart")
                .attr("height") - margin.top - margin.bottom

        //-------------------------------START LINE CHART------------------------------//
        //container
        // define the dimensions and margins for the bar chart

        var grouped_hold = d3.nest()
                .key(d => d.year)
                .key(d => d.average_rating)
                .rollup(v => v.length)
                .entries(data)

        var grouped = grouped_hold.map(dYear => {
          var dCounts = Object.fromEntries(dYear.values.map(count => [count.key, count.value]));

          var ratings = Array.from({length: d3.max(data, d => d.average_rating) + 1}, (_, i) => ({
            rating: i,
            count: dCounts[i] || 0
          }));

          return {
            year: +dYear.key,
            ratings: ratings
          };
        });

        var svgLine = d3.select("#line_chart")

        var container = svgLine.select("#container")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        var xScale = d3.scaleLinear()
                .domain([0, d3.max(grouped, d => d3.max(d.ratings, w => w.rating))])
                .range([0, width])

        var yScale = d3.scaleLinear()
                .domain([0, d3.max(grouped, d => d3.max(d.ratings, w => w.count))])
                .range([height, 0])

        //.attr("transform", "translate(${margin.left}, ${margin.top})")


        // lines
        var myColor = d3.scaleOrdinal(["#648FFF", "#785EF0", "#DC267F", "#FE6100", "#FFB000"])

        var linesA = container.select("#lines")

        grouped.forEach((dYear, i) => {
          dYear.ratings.sort((a, b) => d3.ascending(a.rating, b.rating))
          var line = d3.line()
                  .x(d => xScale(d.rating))
                  .y(d => yScale(d.count))

          linesA.append("path")
                  .datum(dYear.ratings)
                  .style("stroke", myColor(i))
                  .style("fill", 'none')
                  .attr("d", line)
          // dots
          var dotsA = container.select("#circles")
          dotsA.selectAll(`.dot-${dYear.year}`)
                  .data(dYear.ratings)
                  .enter()
                  .append("circle")
                  .attr('class', `.dot-${dYear.year}`)
                  .attr("cx", d => xScale(d.rating))
                  .attr("cy", d => yScale(d.count))
                  .attr("r", 5)
                  .style("fill", myColor(i))
                  .on("mouseover", function (event, d) {
                    // Call hoverBars on mouseover
                    hoverBars(dYear.year, d)
                    d3.select(this).transition().duration(200)
                            .attr("r", 12);
                    // console.log("what is d: ", d)
                    //  console.log("what its calling:", dYear.year, +d)
                  })
                  .on("mouseout", function () {
                    // Reset bar chart or hide it
                    d3.select(this).transition().duration(200)
                            .attr("r", 5);
                    container.selectAll('#bars').remove(); // Clear the bar chart on mouse out
                  })

          // x-axis

          var xAxisL = container.select("#x-axis-lines")
                  .attr("transform", "translate(0," + height + ")")
                  .call(d3.axisBottom(xScale))

          xAxisL.append('text')
                  .attr('x', width / 2)
                  .attr('y', height + margin.bottom - 10)
                  .text('Rating')
                  .style("font-family", "sans-serif")
                  .style("font-weight", "bold")

          //y-axis

          var yAxisL = container.select("#y-axis-lines")
                  .call(d3.axisLeft(yScale))

          yAxisL.append('text')
                  .attr('x', width / 2)
                  .attr('transform', "rotate(-90)")
                  .attr("y", -margin.left / 2 - 10)
                  .attr('x', -height / 2 - margin.top / 2)
                  .text('text-anchor', 'middle')
                  .text("Count")
                  .style("font-family", "sans-serif")
                  .style("font-weight", "bold")

          //title
          container.select('#line_chart_title')
                  .attr("x", width / 2)
                  .attr("y", -margin.top / 2)
                  .attr('text-anchor', 'middle')
                  .text('Board games by Rating 2015-2019')
          // credit
          container.select('#credit')
                  .attr("x", width / 2)
                  .attr("y", -margin.top / 2 + 20)
                  .text('hpavlovich3')

          //legend

          var legendA = container.select("#legend")

          years = ['2015', '2016', '2017', '2018', '2019']
          color = ["#648FFF", "#785EF0", "#DC267F", "#FE6100", "#FFB000"]
          for (var i = 0; i < years.length; i++) {
            legendA.append("circle")
                    .attr("cx", width - 35)
                    .attr("cy", 25 * i)
                    .attr("r", 5)
                    .style("fill", color[i])
            legendA.append("text")
                    .attr("x", width - 20)
                    .attr("y", 25 * i)
                    .text(years[i])
                    .style("font-size", "14px").style("font-weight", "bold").style('font-family', 'sans-serif').attr("alignment-baseline", "middle")
          }
        })

        //console.log(data); // you should see the data in your browser's developer tools console

        //-------------------------------END LINE CHART------------------------------//

        //-------------------------------START BAR CHART------------------------------//

        // bars
        var svgBar = d3.select("#bar_chart")

        var container_2 = svgBar.select("#container_2")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        var barGrouped_hold = d3.nest()
                .key(d => d.year)
                .key(d => d.average_rating)
                .key(d => d.name)
                .rollup(v => d3.sum(v, d => d.users_rated))
                .entries(data)

        var barGrouped = barGrouped_hold.map(barYear => {
          var barRatings = barYear.values.map(barRating => {
            var barGames = barRating.values.map(game => ({
              name: game.key,
              count: game.value
            }))

            return {
              rating: +barRating.key,
              count: barGames
            }
          })

          return {
            year: +barYear.key,
            ratings: barRatings
          }
        });

        function hoverBars(year, selected_rating) {
          // console.log('moused over rating:',selected_rating)
          var topFive_year = barGrouped.find(d => +d.year === +year)
          if (!topFive_year) {
            return
          }
            //  console.log("year: ", year, " rating: ", selected_rating)
            //  console.log("topFive year: ", topFive_year)

          var topFive_rating = topFive_year.ratings.find(d => +d.rating === +selected_rating)
          if (!topFive_rating) {

            d3.select("#bar_chart").style("display", "none"); // Set to 'none'

            container_2.select("#bars").selectAll("*").remove();

            // Clear the axes
            container_2.select("#x-axis-bars").selectAll("*").remove();
            container_2.select("#y-axis-bars").selectAll("*").remove();

            // Clear any titles or labels
            d3.select("#bar_chart_title").text("")
            d3.select("#bar_x_axis_label").text("")
            d3.select("#bar_y_axis_label").text("")// Clear the title
            return; // Exit the function
          }
          d3.select("#bar_chart").style("display", "block")
          var topFive = topFive_rating.count
                  .sort((a, b) => b.count - a.count)
                  .slice(0, 5)

          //console.log("i selected rating:",selected_rating, "topFive: ", topFive)
          // console.log(topFive)
          container_2.select("#bars").selectAll("*").remove();

          var xScaleBar = d3.scaleLinear()
                  .domain([0, d3.max(topFive, d => d.count)])
                  .range([0, width])

          var yScaleBar = d3.scaleBand()
                  .domain(topFive.map(d => d.name))
                  .range([0, height])
                  .padding(0.1)

          var bar = container_2.select("#bars")

          bar.selectAll(".bar")
                  .data(topFive)
                  .enter()
                  .append("rect")
                  .attr("class", "bar")
                  .attr("x", 0)
                  .attr("y", d => yScaleBar(d.name))
                  .attr("width", d => xScaleBar(d.count))
                  .attr("height", yScaleBar.bandwidth())
                  .style("fill", "rgba(0, 0, 255, 0.5)")
                  .style("fill-opacity", '50')


          // x-axis

          var xAxisB = container_2.select("#x-axis-bars")

          xAxisB.attr("transform", "translate(0," + height + ")")
                  .call(d3.axisBottom(xScaleBar)
                          .tickSize(-height))

          //y-axis
          var yAxisB = container_2.select("#y-axis-bars")

          yAxisB.call(d3.axisLeft(yScaleBar)
                          .tickFormat(d => d.substring(0, 10)))

          // axis text
          var xAxisText = container_2.select("#bar_x_axis_label")

          xAxisText.selectAll("*").remove()
          xAxisText.text('Number of users')
                  .attr('x', width / 2 - margin.left / 2)
                  .attr('y', height + margin.bottom - 10)

                  .style("font-family", "sans-serif")
                  .style("font-weight", "bold")

          var yAxisText = container_2.select("#bar_y_axis_label")
          yAxisText.selectAll("*").remove()
          yAxisText.text("Games")
                  .attr('x', width / 2)
                  .attr('transform', "rotate(-90)")
                  .attr("y", -margin.left / 2 - 10)
                  .attr('x', -height / 2 - margin.top / 2)
                  .attr('text-anchor', 'middle')
                  .style("font-family", "sans-serif")
                  .style("font-weight", "bold")

          //title
          var bar_title = d3.select("#bar_chart_title")

          bar_title.text(`Top 5 Most Rated Games of ${year} with Rating ${selected_rating}`)


        }


    //-------------------------------END BAR CHART------------------------------//

      }).catch(function (error) {
      console.log(error);
    })


  </script>

</body>
