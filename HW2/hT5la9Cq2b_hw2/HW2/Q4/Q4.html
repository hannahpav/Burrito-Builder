<!DOCTYPE html>

<head>
  <title>Games Rating: 2015 - 2019</title>
  <meta charset="utf-8">
  <style>
    #line {
          fill: none; /* No fill for the line */
          stroke-width: 1.5;
        }

    #line_chart_title, #bar_chart_title {
      font-size: 18px;
      text-anchor: middle;
      font-family: sans-serif;
      font-weight: bold;
    }

    #x_axis_label,#y_axis_label,#bar_x_axis_label,#bar_y_axis_label {
      font-size: 14px;
      text-anchor: middle;
      font-family: sans-serif;
      font-weight: bold;
    }

    #line_label {
      font-size: 10px;
      text-anchor: left;
      font-family: sans-serif;
      font-weight: normal;
    }

    #credit {
      font-size: 12px;
      text-anchor: end;
      font-family: sans-serif

    }

    #dotText{
      font-size:10px;
      text-anchor: middle;
      font-family: sans-serif;
      fill: white;
    }

  </style>
</head>

<body>
  <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
  <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>

  <!-- Example hiding an element -->
  <!-- <g id="" style"display:none;" /> -->

  <!-- Example of styling an element -->
  <!-- svg_element.style()-->

  <svg id ="line_chart" width = "800" height = "400"></svg>

  <div id="bar_chart_title"></div>
  <svg id ="bar_chart" width = "800" height = "400"></svg>  <script>

  // get data

  // Fetch the data
	var pathToCsv = "average-rating.csv";

    d3.dsv(",", pathToCsv).then(data_raw => {
      data_raw.forEach(d => {
        d.name = d.name
        d.year = +d.year
        d.average_rating = Math.floor(+d.average_rating)
        d.users_rated = +d.users_rated
      })

 //     var startYear = d3.timeParse("%Y")(2015);
 //     var endYear = d3.timeParse("%Y")(2019);

      var data = data_raw.filter(row =>{
            return 2015 <= row.year && row.year <= 2019;
          });

      var margin = {top: 80, right: 120, bottom: 40, left: 80}
      var width = d3.select("#line_chart")
              .attr("width") - margin.left - margin.right

      var height = d3.select("#line_chart")
              .attr("height") - margin.top - margin.bottom

      //-------------------------------START LINE CHART------------------------------//
      //container
    // define the dimensions and margins for the bar chart

      var grouped_hold = d3.nest()
              .key(d =>  d.year)
              .key(d => d.average_rating)
              .rollup(v => v.length)
              .entries(data)

      var grouped = grouped_hold.map(dYear => {
        var dCounts = Object.fromEntries(dYear.values.map(count => [count.key, count.value]));

        var ratings = Array.from({ length: d3.max(data, d => d.average_rating) + 1 }, (_, i) => ({
          rating: i,
          count: dCounts[i] || 0
        }));

        return {
          year: +dYear.key,
          ratings: ratings
        };
      });

      var xScale = d3.scaleLinear()
              .domain([0, d3.max(grouped, d=> d3.max(d.ratings, w=> w.rating))])
              .range([0, width])

      var yScale = d3.scaleLinear()
              .domain([0, d3.max(grouped, d => d3.max(d.ratings, w=> w.count))])
              .range([height, 0])

      var svgLine = d3.select("#line_chart")
              .append('g')
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      //.attr("transform", "translate(${margin.left}, ${margin.top})")

      // Container group
      var plotLine = svgLine.append('g')
              .attr('id', 'container');

      // lines
      var myColor = d3.scaleOrdinal(d3.schemeCategory10)

      var linesA = plotLine.append("g")
              .attr("id", "lines")

      grouped.forEach((dYear, i) => {
        dYear.ratings.sort((a,b) => d3.ascending(a.rating, b.rating))
        var line = d3.line()
                .x(d => xScale(d.rating))
                .y(d => yScale(d.count))

        linesA.append("path")
                .datum(dYear.ratings)
                .attr("id", "line")
                .attr("d", line)
                .style("stroke", myColor(i))

      // dots
      var dotsA = linesA.append("g")
        .attr("id", "circles")

      dotsA.selectAll(`.dot-${dYear.year}`)
        .data(dYear.ratings)
        .enter()
        .append("circle")
        .attr('class',`.dot-${dYear.year}`)
        .attr("cx", d => xScale(d.rating))
        .attr("cy", d => yScale(d.count))
        .attr("r", 5)
        .style("fill", myColor(i))
        .on("mouseover", function(event, d) {
          // Call hoverBars on mouseover
          hoverBars(dYear.year, d.rating)
          d3.select(this).transition().duration(200)
                  .attr("r", 12);
        })
        .on("mouseout", function() {
          // Reset bar chart or hide it
          d3.select(this).transition().duration(200)
                  .attr("r", 5);
          plotBar.selectAll('#bars').remove(); // Clear the bar chart on mouse out
        })

      // x-axis

      linesA.append("g")
              .attr("id", "x-axis-lines")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom(xScale))

      linesA.append('text')
              .attr('x', width / 2)
              .attr('y', height + margin.bottom-10)
              .text('Rating')
              .style("font-family", "sans-serif")
              .style("font-weight", "bold")

      //y-axis

      linesA.append('g')
              .attr("id", "y-axis-lines")
              .call(d3.axisLeft(yScale))

      linesA.append('text')
              .attr('x', width / 2)
              .attr('transform', "rotate(-90)")
              .attr("y", -margin.left / 2 - 10)
              .attr('x', -height / 2 - margin.top/2)
              .text('text-anchor', 'middle')
              .text("Count")
              .style("font-family", "sans-serif")
              .style("font-weight", "bold")

      //title
      linesA.append('text')
              .attr('id', 'line_chart_title')
              .attr("x", width / 2)
              .attr("y", -margin.top/2)
              .attr('text-anchor', 'middle')
              .text('Board Games by Rating 2015-2019')
      // credit
      linesA.append('text')
              .attr('id', 'credit')
              .attr("x", width / 2)
              .attr("y", -margin.top/2+20)
              .text('hpavlovich3')

      //legend

      var legendA = svgLine.append('g')
              .attr('id', 'legend')

      var years = [2015,2016,2017,2018,2019]
      color = d3.schemeCategory10
      for (var i = 0; i < years.length; i++) {
          legendA.append("circle")
                  .attr("cx",width-35)
                  .attr("cy",25*i)
                  .attr("r", 5)
                  .style("fill", color[i])
          legendA.append("text")
                  .attr("x", width-20)
                  .attr("y", 25*i)
                  .text(years[i])
                  .style("font-size", "14px").style("font-weight","bold").style('font-family', 'sans-serif').attr("alignment-baseline","middle")
      }

      //console.log(data); // you should see the data in your browser's developer tools console

    //-------------------------------END LINE CHART------------------------------//

    //-------------------------------START BAR CHART------------------------------//


      // bars
      var svgBar = d3.select("#bar_chart")

      var plotBar = svgBar.append('g')
                .attr('id', 'container2')

      function hoverBars(year, rating) {
        var topFive = data.filter(d => d.year === year && d.user_rating === rating)
                .sort((a, b) => b.rating - a.rating)
                .slice(0,5)

        plotBar.selectAll('#bars').remove();

        var xScaleBar = d3.scaleLinear()
                .domain([0, d3.max(topFive, d => d.users_rated)])
                .range([0, width])

        var yScaleBar = d3.scaleBand()
                .domain(topFive.map(d => d.name))
                .range([height, 0])
                .padding(0.1)

        var bar = plotBar.append('g')
                .attr('id', 'bars')

        bar.selectAll(".bar")
                .data(topFive)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", margin.left)
                .attr("y", d => yScaleBar(d.name))
                .attr("width", d => xScaleBar(d.users_rated))
                .attr("height", yScaleBar.bandwidth())
                .attr("fill", d => myColor(d.name));


        // x-axis
        bar.append("g")
                .attr("id", "x-axis-bars")
                .attr("transform", "translate("+margin.left+"," + height + ")")
                .call(d3.axisBottom(xScaleBar))

        bar.append('text')
                .attr('x', width / 2)
                .attr('transform', "rotate(-90)")
                .attr("y", -margin.left / 2 - 10)
                .attr('x', -height / 2 - margin.top/2)
                .text('text-anchor', 'middle')
                .text("Count")
                .style("font-family", "sans-serif")
                .style("font-weight", "bold")

        //y-axis

        bar.append('g')
                .attr("id", "y-axis-bars")
                .attr("transform", "translate("+margin.left+", 0 )")
                .call(d3.axisLeft(yScaleBar))

        bar.append('text')
                .attr('id', 'bar_y_axis_label')
                .attr('x', width / 2)
                .attr('transform', "rotate(-90)")
                .attr("y", -margin.left / 2 - 10)
                .attr('x', -height / 2 - margin.top / 2)
                .text('text-anchor', 'middle')
                .text("Count")
                .style("font-family", "sans-serif")
                .style("font-weight", "bold")

        //title
        bar.append('text')
                .attr('id', 'bar_chart_title')
                .attr("x", width / 2)
                .attr("y", -margin.top / 2)
                .attr('text-anchor', 'middle')
                .text('WELL THIS SI TRICKY')


      }
   })

    //-------------------------------END BAR CHART------------------------------//

      }).catch(function (error) {
      console.log(error);
    })


  </script>

</body>
